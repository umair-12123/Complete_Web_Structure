<?php
$order_id = $block->getCurrentOrder();
$orderIdToDisplay = "";
$orderDetailsToDisplay = "";
$customerName = "";
$customerEmail = "";
$billingName = "";
$shippingName = "";
$purchaseDate = "";
$purchasePoint = "";

if ($order_id != 0) {
    $order = $block->getOrderById($order_id); // Fetch the entire order object
    if ($order) {
        $orderItemsCollection = $block->orderItemsCollection($order_id);
        $orderIdToDisplay = $order->getIncrementId();
        $customerName = $order->getCustomerName();
        $customerEmail = $order->getCustomerEmail();
        $billingName = $order->getBillingAddress()->getName();
        $shippingName = $order->getShippingAddress()->getName();
        $purchaseDate = $order->getCreatedAt();
        $purchasePoint = $order->getPurchasePoint();
    }
}
?>
<div class="order-card">
    <div class="order-id-div">
        <h1 class="inn_order_id_div">Order Research</h1>
        <div class="div_image">
            <img class="image_logo" src="<?php echo $block->getViewFileUrl('AsquareTec_OrderScanner::images/back_1.png'); ?>" alt="Your Image" />
        </div>
    </div>
    <div class="flex_div_order">
        <div class="search-bar">
            <input class="search-bar-inn" type="text" placeholder="Search Any SKU" />
            <button class="search-button">Search</button>
        </div>
        <div class="flex_text">
            <div class="serch-result">Search Result</div>
            <div class="item-sku">Item Sku:</div>
            <button class="print-search">Print Search Results</button>
        </div>
    </div>
    <div class="order-det">
        <div class="order-table">
            <table class="f_table_order">
                <thead class="t_head_order">
                    <tr>
                        <th class="t_head">Item image</th>
                        <th class="t_head">Item Name</th>
                        <th class="t_head">UPC</th>
                        <th class="t_head">SKU</th>
                        <th class="t_head">Select</th>
                    </tr>
                </thead>
                <tbody class="t_body_order">
                    <!-- Rows will be appended here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script type="text/javascript">
    require(['jquery'], function($) {
        $(document).ready(function() {
            var customUrl = '<?= $block->getUrl('custompage/custom/search') ?>';

            // Handle search button click
            $('.search-button').on('click', function() {
                performSearch();
            });

            // Handle Enter key press in the search input field
            $('.search-bar-inn').on('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Function to handle the search operation
            function performSearch() {
                var searchTerm = $('.search-bar-inn').val().trim();

                if (!searchTerm) {
                    $('.serch-result').html('Please enter a search term.');
                    return;
                }

                $.ajax({
                    url: customUrl,
                    type: 'GET',
                    data: {
                        search: searchTerm,
                        isAjax: true
                    },
                    success: function(response) {
                        if (response.error) {
                            $('.serch-result').html(response.error);
                        } else {
                            // Clear the previous product from the list
                            $('.f_table_order tbody').empty();
                            var count = 1;
                            $.each(response, function(index, value) {
                                if (count == 1) {
                                    // Update product image
                                    $('#product-image-source').attr('src', value.imagePath);

                                    // Update item details in ID Card section
                                    $('#item_name').text(value.itemName);
                                    $('#item_upc_value').text(value.upc);
                                    $('#item_color_value').text(value.color);

                                    // Update the brand logo if available
                                    $('#brdwallmg').attr('src', value.brandLogo);
                                }
                                count++;

                                var price = parseFloat(value.price);
                                // Append new row to the product table section
                                var newRow = '<tr data-sku="'+ value.sku + '">' +
                                    '<td class="t_data"><img src="' + value.imagePath + '" alt="Item Image" style="max-width: 50px; max-height: 50px;" /></td>' +
                                    '<td class="t_data">' + value.itemName + '</td>' +
                                    '<td class="t_data">' + value.upc + '</td>' +
                                    '<td class="t_data">' + value.sku + '</td>' +
                                    '<td class="t_data"><button class="order-search-btn">search</button></td>' +
                                    '</tr>';

                                $('.f_table_order tbody').append(newRow);
                            });

                            // Optionally, clear the search input after adding to the table
                            $('.search-bar-inn').val('');
                        }
                    },
                    error: function() {
                        $('.serch-result').html('An error occurred while fetching product details.');
                    }
                });
            }

        });
    });
</script>
